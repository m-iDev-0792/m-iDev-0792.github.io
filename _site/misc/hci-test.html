<!DOCTYPE HTML>
<html lang="zh-CN">
<head>
    <!-- https://stackoverflow.com/questions/9100344/pure-css-multi-level-drop-down-menu -->
    <meta charset="UTF-8">
    <title>Menu Selection Test</title>
    <script type="text/javascript" src="https://libs.baidu.com/jquery/1.9.0/jquery.js"></script>
    <link rel="stylesheet" href="https://libs.baidu.com/bootstrap/3.0.3/css/bootstrap.min.css"/>
    <!-- <link rel="stylesheet" href="menu.css" /> -->
    <script type="text/javascript" src="https://libs.baidu.com/bootstrap/3.0.3/js/bootstrap.min.js"></script>
    <script src="https://cdn.bootcss.com/FileSaver.js/2014-11-29/FileSaver.js"></script>
    <style>
        :root{
            --menuHeight:30px;
            --menuWidth:150px;
            --menuFontSize:14px;
            --menuHeightMinus:-30px;
            --menuWidthMinus:-150px;
            --menuAColor:#FFFFFF;
            --menuAHoverColor:#000000;
            --menuLiColor:#999999;
            --menuLiHoverColor: #CCCCCC;
        }
        /* 次级 */
        .sub-level-menu {
            position: relative;
            top: calc(var(--menuHeightMinus));
            right: calc(var(--menuWidthMinus));
            width: var(--menuWidth);
            list-style: none;
            padding: 0;
            margin: 0;
            display: none;
        }
        .sub-level-menu>li {
            height: var(--menuHeight);
            background: #999999;
        }
        .sub-level-menu>li:hover {
            background: #CCCCCC;
        }
        /* 第一级 */
        .first-level-menu {
            position: absolute;
            top: 30px;/*top应该和menu-switch的高度一样*/
            left: 0;
            width: var(--menuWidth);
            list-style: none;
            padding: 0;
            margin: 0;
            display: none;
        }
        .first-level-menu>li {
            position: relative;
            height: var(--menuHeight);
            background: #999999;
        }
        .first-level-menu>li:hover {
            background: #CCCCCC;
        }

        .first-level-menu li:hover>ul {
            /* 当 menu-switch的任意子代li有鼠标移动上去,则显示li的直接后代ul */
            display: inline;
        }
        /*设置所有的a标签的样式*/
        .first-level-menu a{
            font: bold var(--menuFontSize) Arial, Helvetica, sans-serif;
            color: #FFFFFF;
            text-decoration: none;
            padding: 0 0 0 10px;
            /* Make the link cover the entire list item-container */
            display: block;
            line-height: var(--menuHeight);
            text-align: left;
        }
        .first-level-menu a:hover {
            color: #000000;
        }
        /* 最高级 */
        .menu-switch {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .menu-switch>li {
            position: relative;
            float: left;
            height: 30px;
            width: 200px;
        }
        #dLabel{
            font: bold 16px Arial, Helvetica, sans-serif;
            color: #FFFFFF;
            background: #3276b1;
            text-decoration: none;
            /* padding: 0 0 0 10px; */
            /* Make the link cover the entire list item-container */
            height: 30px;
            width: 150px;
            display: block;
            text-align: center;
            line-height: 30px;
            border-radius: 5px;
            
        }
        #regenrateBtn{
            font: bold 16px Arial, Helvetica, sans-serif;
            color: #FFFFFF;
            background: #3276b1;
            text-decoration: none;
            /* padding: 0 0 0 10px; */
            /* Make the link cover the entire list item-container */
            height: 30px;
            width: 150px;
            display: block;
            text-align: center;
            line-height: 30px;
            border-radius: 5px;
            
        }
        /* 当 menu-switch的任意子代li有鼠标移动上去,则显示li的直接后代ul */
        /* .menu-switch li:hover>ul {
            display: inline;
        } */
        #zero{
            margin: 0px;
            padding: 0px;
        }


    </style>
</head>
<body>
<div class="container" id="main" display="flex">
    <div>
        <h2 id="bigtitle">欢迎参加菜单选择测试!</h2>
        <form role="form" class="form-inline">
            <label>选择测试回合</label>&nbsp;&nbsp;
            <select class="form-control-sm" id="roundSelecter">
                <option>100</option>
                <option>5</option>
                <option>10</option>
                <option>20</option>
                <option>50</option>
                <option>150</option>
                <option>200</option>
                <option>300</option>
                <option>500</option>
            </select>
        </form>
    </div>
    <div>
        <h4 id="progressText">当前进度 - 测试未开始</h4>
        <div class="progress">
            <div class="progress-bar" id="progressBar" style="width: 100%;">
                <span class="sr-only" color="red">40% finished</span>
            </div>
        </div>
    </div>
    <h3 id="title">请点击'开始'按钮来开始测试</h3>
    <h4>
        <font color="red">提示: 当您感觉菜单不合理时,请点击'重新生成'.</font>
    </h4>
    <ul class="menu-switch" id="menuContainer">
        <li><a id="dLabel" text-align="center" href="#">
                开始<span class="caret"></span>
            </a>
            <!--insert menu here-->
        </li>
        <li><a id="regenrateBtn" text-align="center" href="#" onclick="regenerateMenu()">重新生成!</a></li>
    </ul>
    

    <br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
    <!-- collapse panel -->
    <div class="panel panel-default">
        <div class="panel-heading">
            <h4 class="panel-title">
                <a data-toggle="collapse" data-parent="#accordion" href="#collapseOne">
                    点击此处折叠或显示日志
                </a>
            </h4>
        </div>
        <div id="collapseOne" class="panel-collapse collapse in">
            <div class="panel-body" id="logText">
                Page loaded sucessfully, ready to proceed a test.<br>
                Please press 'Start' button to start test...
            </div>
        </div>
    </div>
</div>
<!-- 模态框（Modal） -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                    &times;
                </button>
                <h4 class="modal-title" id="myModalLabel">
                    祝贺!你已经完成了所有测试
                </h4>
            </div>
            <div class="modal-body">
                填写您的相关信息,然后请点击'下载'按钮来下载结果,并把结果发送给我们,谢谢! ;)<br>
                姓名: <input type="text" class="form-control" id="testerName"><br>
                性别:
                <div class="btn-group" id="gender" data-toggle="buttons">
                    <label class="btn btn-default blue">
                        <input type="radio" class="toggle" value="m">男
                    </label>
                    <label class="btn btn-default blue">
                        <input type="radio" class="toggle" value="f">女
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="saveResultAsCSV()">下载</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal -->
</div>
</body>
<script>
    //Global objects
    var title;
    var firstLevelMenu;
    var logText;
    var menuStartBtn;
    var progressBar;
    var progressText;
    //Global variables
    var firstPress=true;
    var maxRound=10;
    var currentRound=1;
    var startPressed=false;
    var roundStartTime;
    var roundEndTime;
    var instructText;
    //menu parameters
    var menuWidth = 150;
    var menuHeight = 30;
    var fontSize = 14;
    var menuLength=[4, 5, 6];
    var menuTargetPos= [2, 3, 4];
    //Record parameters and results
    var records=[];
    //menu item title data
    var title1 = ['保存','新建','删除','撤销','重做','另存为','导出','导入','粘贴','剪切','复制','查找','替换','关闭','最小化','最大化','全选','反选'];
    var title2 = ['北京','上海','广州','深圳','大连','厦门','沈阳','武汉','长沙','南昌','哈尔滨','长春','郑州','石家庄','南京','杭州','苏州'];
    var title3 = ['苹果','香蕉','橘子','桃子','榴莲','西瓜','枣子','葡萄','芒果','柠檬','草莓','椰子','菠萝','荔枝','乌梅','樱桃','甘蔗'];
    var title4 = ['番茄','青菜','白菜','菠菜','胡萝卜','冬瓜','丝瓜','豆角','包菜','辣椒','韭菜','蒜苗','豆芽','生菜','花菜','山药'];
    var title5 = ['中国','蒙古','朝鲜','韩国','日本 ','芬兰','瑞典','挪威','冰岛','丹麦','英国','爱尔兰','荷兰','比利时','卢森堡','法国','摩纳哥','加拿大','美国','墨西哥','哥伦比亚','委内瑞拉','意大利','埃及','利比亚','苏丹','突尼斯','阿尔及利亚','摩洛哥','埃塞俄比亚'];
    var title6 = ['老虎','狼','老鼠','麋鹿','貂','猴子','树懒', '斑马','狗','狐狸','棕熊','大象','豹子','狮子','大熊猫','疣猪','羚羊','驯鹿','考拉','犀牛','穿山甲','长颈鹿','小熊猫','食蚁兽',' 猩猩','海牛','水獭','灵猫','海豚','海象','鸭嘴兽','刺猬','北极狐','无尾熊','北极熊','袋鼠','河马','海豹','鲸鱼'];
    var title7 = ['自行车', '电动车', '摩托', '公交', '大巴', '出租', '小汽车', '有轨电车', '无轨电车', '地铁', '火车', '客机', '直升机', '邮轮', '帆船', '汽艇', '游船', '游艇', '气垫船', '马车', '三轮车'];
    var title8 = ['应用化学','天文学','经济学','国际贸易','法律','计算机','现代文学','考古学','天体物理学','材料科学','统计学','环境科学','口腔医学','政治学','电气工程','通信工程','保险学','控制工程'];
    var title9 = ['霸王别姬','阿甘正传','盗梦空间','星际穿越','无间道','熔炉','怦然心动','遗愿清单','乱世佳人','罗马假日','指环王','天空之城','死亡诗社','教父2','狮子王','黑客帝国','让子弹飞','美国往事','七宗罪','勇敢的心'];
    var title10 = ['联想','戴尔','惠普','华硕','苹果','三星','华为','微软','小米','微星','外星人','荣耀','神舟','索尼','松下','雷蛇','宏碁','LG','ThinkPad'];
    var allTitleDatas=[title1, title2, title3, title4, title5, title6, title7, title8, title9, title10];
    window.onload = function () {
        //init global objects
        title = document.getElementById('title');
        logText=document.getElementById('logText');
        menuStartBtn= document.getElementById('dLabel');
        progressBar =document.getElementById('progressBar');
        progressText = document.getElementById('progressText');
        //init menu
        firstLevelMenu=createMenu(menuLength,menuTargetPos);
        menuStartBtn.appendChild(firstLevelMenu);
            title.innerHTML = '请点击<font color="red">开始</font>并选择菜单项 '+instructText;
        //add menu click event response
        document.addEventListener("click", event => {
            var cDom = menuStartBtn;
            var tDom = event.target;
            if (cDom == tDom || cDom.contains(tDom)) {
                firstLevelMenu.style.display = 'inline';
                startNewRound();
            } else {
                firstLevelMenu.style.display = 'none';
            }
        });
    };
    function startNewRound(){
        if(currentRound>maxRound||startPressed){
            return;
        }
        if(firstPress){
            maxRound=$("#roundSelecter").val();
            $("#roundSelecter").prop("disabled", true);
            $(".selectpicker[data-id='roundSelecter']").addClass("disabled");
            progressText.innerHTML = 'Current Progress - 0 / ' + maxRound + ' finished';
            progressBar.setAttribute('style', 'width: 0%;');
            firstPress=false;
        }
        var singleRecord={"width":menuWidth,"height":menuHeight,"fontSize":fontSize,
        "l1length":menuLength[0], "l2length": menuLength[1], "l3length": menuLength[2],
        "l1target":menuTargetPos[0], "l2target": menuTargetPos[1], "l3target": menuTargetPos[2],
        "time":0};
        // console.log("new parameter"+currentRound);
        // console.log(singleRecord);
        records[currentRound-1]=singleRecord;
        startPressed=true;
        roundStartTime = new Date();
    }
    //生成从minNum到maxNum的随机数
    function randomNum(minNum, maxNum) {
        switch (arguments.length) {
            case 1:
                return parseInt(Math.random() * minNum + 1, 10);
                break;
            case 2:
                return parseInt(Math.random() * (maxNum - minNum + 1) + minNum, 10);
                break;
            default:
                return 0;
                break;
        }
    }
    function generateParameters(){
        menuWidth = randomNum(50, 300);
        menuHeight = randomNum(10, 60);
        fontSize = randomNum(5, 60);
        while (fontSize > menuHeight*0.9 || fontSize < menuHeight * 0.4) {
            fontSize = randomNum(5, 60);
        }

        menuLength=[randomNum(2, 10),0,0];//只有一项的菜单毫无意义,最低2项
        menuTargetPos=[randomNum(0, menuLength[0] - 1),0,0];
        //generate sub level menu
        const threshold=6;
        const maxLength=10;
        for(i=1;i<3;++i){
            var rn= randomNum(1, maxLength+threshold-1);
            if(rn<= threshold){//sub level menus are more likely to be null
                break;
            }else rn-= threshold-1;//只有一项的菜单毫无意义,最低2项
            menuLength[i]=rn;
            menuTargetPos[i]=randomNum(0, menuLength[i] - 1);
        }
    }
    function regenerateMenu() {
        if (currentRound > maxRound)return;
        //reset variables
        startPressed = false;
        //delete old menu
        menuStartBtn.removeChild(firstLevelMenu);
        //generate new menu parameters
        generateParameters();
        //set new menu style
        firstLevelMenu = createMenu(menuLength, menuTargetPos);
        menuStartBtn.appendChild(firstLevelMenu);
        setMenuStyle(menuWidth, menuHeight, fontSize);
        //update instruction text
        var insText= menuTargetPos[0];
        for(k=1;k<menuLength.length;++k){
            if(menuLength[k]>0)
                insText+= '->'+menuTargetPos[k];
            else
                break;
        }
        title.innerHTML = '请点击<font color="red">开始</font>然后选择菜单项 ' + instructText;
    }
    //目标项点击事件
    function endRound(){
        roundEndTime=new Date();
        var interval=roundEndTime-roundStartTime;
        records[currentRound-1].time=interval;
        logText.innerHTML=logText.innerHTML+'<br>'+'selection '+currentRound+' time:'+interval+'ms';
        logText.innerHTML=logText.innerHTML+ '<br> Parameters:'+ JSON.stringify(records[currentRound-1]);
        var p = currentRound / maxRound * 100;
        progressBar.setAttribute('style', 'width:' + p + '%;');
        progressText.innerHTML= '当前进度 - '+currentRound+' / '+maxRound+' 已完成';
        //reset variables
        ++currentRound;
        //test is over
        if(currentRound>maxRound){
            startPressed = false;
            $('#myModal').modal('show')
            document.getElementById('bigtitle').innerHTML="测试结束,要再来一轮测试,请重载本页面!";
            return;
        }
        regenerateMenu();
    }
    function saveResult(){
        var content="";
        for(i=0;i<records.length;++i){
            content+= JSON.stringify(records[i])+"\n";
        }
        var blob = new Blob([content], { type: "text/plain;charset=utf-8" });
        var gender = $('#gender input:radio:checked').val();
        var name = $("#myModal #testerName").val().trim();
        var t = new Date();
        var tt = t.getFullYear() + "-" + t.getMonth() + "-" + t.getDate() + "-" + t.getHours() + "-" + t.getMinutes();
        saveAs(blob, name + "-" + gender + "-" + tt + ".txt");
    }
    function saveResultAsCSV() {
            var content = "width,height,font size,L1 length,L2 length,L3 length,L1 target,L2 target,L3 target,time\n";
            for (i = 0; i < records.length; ++i) {
                content += records[i].width+','+ records[i].height + ',' + records[i].fontSize + ','
                + records[i].l1length + ',' + records[i].l2length + ',' + records[i].l3length + ','
                + records[i].l1target + ',' + records[i].l2target + ',' + records[i].l3target + ',' + records[i].time + "\n";
            }
            var blob = new Blob([content], { type: "text/plain;charset=utf-8" });
            var gender = $('#gender input:radio:checked').val();
            var name= $("#myModal #testerName").val().trim();
            var t = new Date();
            var tt=t.getFullYear()+"-"+ t.getMonth() + "-"+ t.getDate() + "-" + t.getHours() + "-" + t.getMinutes();
            saveAs(blob, name+"-"+gender+"-"+tt+".csv");
        }
    
    function setMenuStyle(width,height,fontSize){
        document.documentElement.style.setProperty('--menuWidth', width + 'px');
        document.documentElement.style.setProperty('--menuWidthMinus', -width + 'px');

        document.documentElement.style.setProperty('--menuHeight', height + 'px');
        document.documentElement.style.setProperty('--menuHeightMinus', -height + 'px');

        document.documentElement.style.setProperty('--menuFontSize', fontSize + 'px');
    }
    //创建菜单
    function createMenu(subMenuItemNum,subMenuTarget){
        //TODO随机选择三个数据源
        var menuTitleData= [];
        //初始化selection
        var selections = allTitleDatas.concat();
        for(iii=0;iii<3;++iii){
            var selected=randomNum(0,selections.length-1);
            menuTitleData.push(selections[selected].concat());
            selections.splice(selected, 1);
        }
        instructText='';
        var lastMenu=null;
        const menuStyleList=['first-level-menu','sub-level-menu','sub-level-menu'];
        var realLastMenuLevel=0;
        for(i=1;i< subMenuItemNum.length;++i){
            if(subMenuItemNum[i]>0)realLastMenuLevel=i;
            else break;
        }
        for(i=subMenuItemNum.length-1;i>=0;--i){
            //菜单项为0则忽略
            if(subMenuItemNum[i]<=0)continue;
            //创建新的子菜单
            var currentMenu=document.createElement('ul');
            currentMenu.setAttribute('class',menuStyleList[i>2?2:i]);
            currentMenu.setAttribute('id', 'menuLevel' + i);

            for(j=0;j<subMenuItemNum[i];++j){
                var item = document.createElement('a');
                item.setAttribute('href', '#');
                //菜单的标题
                //------------随机选择菜单项标题--------------
                var ti=randomNum(0,menuTitleData[i].length-1);
                item.innerHTML= menuTitleData[i][ti];
                menuTitleData[i].splice(ti,1);
                //------------随机选择菜单项标题--------------
                // item.innerHTML = 'item' + j;
                var li = document.createElement('li');

                if(j==subMenuTarget[i]){//目标选项
                    //添加目标菜单选择提示
                    instructText = item.innerHTML + instructText;
                    if (i > 0) instructText = '->' + instructText;
                    if(lastMenu){//非最后一级菜单的目标选项
                        li.appendChild(item);
                        li.appendChild(lastMenu);//添加上轮建立的菜单
                    }else{//最后一级菜单的目标选项
                        li.appendChild(item);
                        //添加选中触发事件
                        item.setAttribute('onclick','endRound()');
                    }
                }else{//非目标菜单项
                    if (i == realLastMenuLevel) {//最后一级菜单的菜单项无需迷惑
                        li.appendChild(item);
                    } else {
                        //为非最后一级菜单的菜单项添加迷惑
                        li.appendChild(item);
                        var confuse = document.createElement('ul');
                        confuse.setAttribute('class','sub-level-menu');
                        //------------随机选择菜单项标题--------------
                        var ti = randomNum(0, menuTitleData[i+1].length - 1);
                        var temptext = menuTitleData[i+1][ti];
                        menuTitleData[i].splice(ti, 1);
                        //------------随机选择菜单项标题--------------
                        confuse.innerHTML = '<li><a href="#">'+temptext+'</a></li>';
                        li.appendChild(confuse);
                    }
                }
                currentMenu.appendChild(li);
            }
            lastMenu=currentMenu;
        }
        // console.log(lastMenu.outerHTML);
        return lastMenu;
    }
</script>
</html>

